<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>packages/mojo.js/lib/views/list/index.js - Mojo.js Docs</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Mojo.js Docs"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.7.84</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Animator.html">Animator</a></li>
            
                <li><a href="../classes/Application.html">Application</a></li>
            
                <li><a href="../classes/RegisteredClasses.html">RegisteredClasses</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/mojo.html">mojo</a></li>
            
                <li><a href="../modules/mojo-application.html">mojo-application</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: packages/mojo.js/lib/views/list/index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var protoclass = require(&quot;protoclass&quot;),
bindable       = require(&quot;bindable&quot;),
type           = require(&quot;type-component&quot;),
factories      = require(&quot;factories&quot;),
janitor        = require(&quot;janitorjs&quot;),
BaseView       = require(&quot;../base&quot;),
_              = require(&quot;underscore&quot;),
runlater       = require(&quot;runlater&quot;).global,
poolparty      = require(&quot;poolparty&quot;),
idGenerator    = require(&quot;../../utils/idGenerator&quot;);



function ListView (data, application) {
  ListView.parent.call(this, data, application);
}

/**
 */

function onOptionChange (onRef) {
  var binding, selfFn, self = this;
  return selfFn = function (value) {

    if (binding) {
      binding.dispose();
      binding = undefined;
    }

    if (typeof value === &quot;string&quot;) {
      binding = self.bind(value, onRef).now();
    } else {
      onRef(value);
    }
  };
} 

/**
 */

protoclass(BaseView, ListView, {

  /**
   */

  chunk: 10,

  /**
   */

  delay: 0,

  /**
   * make sure decorations don&#x27;t get activated for this view
   */

  _decorated: true,

  /**
   */

  __isList: true,

  /**
   */

  define: [&quot;filter&quot;, &quot;sort&quot;, &quot;map&quot;, &quot;length&quot;, &quot;modelViewFactory&quot;, &quot;modelViewClass&quot;, &quot;viewClass&quot;, &quot;source&quot;],

  /**
   */

  initialize: function (data) {
    ListView.__super__.initialize.call(this, data);

    this._insertQueue = [];

    // the views of this list
    // _views is deprecated
    this._views = this.children = new bindable.Collection();

    this._views.bind(&quot;length&quot;, { target: this, to: &quot;length&quot; }).now();


    // TODO - need to check for model view factory here
    this._modelViewFactory = factories.factory.create(this.modelViewFactory || this.modelViewClass || this.viewClass);

    this._onFilterChange  = _.bind(this._onFilterChange, this);
    this._onSourceChange  = _.bind(this._onSourceChange, this);
    this._onSortChange    = _.bind(this._onSortChange, this);
    this._onInsertModel   = _.bind(this._onInsertModel, this);
    this._onReplaceModels = _.bind(this._onReplaceModels, this);
    this._onResetModels   = _.bind(this._onResetModels, this);
    this._onRemoveModel   = _.bind(this._onRemoveModel, this);
    this._onMapChange     = _.bind(this._onMapChange, this);
    this._insertNow       = _.bind(this._insertNow, this);
  },

  /**
   */

  _render: function () {
    ListView.__super__._render.call(this);

    // running in test mode, or in node? cannot have any delay.
    if (!process.browser || this.application.fake) {
      this.delay = false;
    }

    if (this._bindingJanitor) {
      this._bindingJanitor.dispose();
    }

    this._bindingJanitor = janitor();

    this._bindingJanitor.
      add(this.bind(&quot;sort&quot;, onOptionChange.call(this, this._onSortChange)).now()).
      add(this.bind(&quot;map&quot;, onOptionChange.call(this, this._onMapChange)).now()).
      add(this.bind(&quot;filter&quot;, onOptionChange.call(this, this._onFilterChange)).now()).
      add(this.bind(&quot;source&quot;, onOptionChange.call(this, this._onSourceChange)).now());
  },

  /**
   */

  _onSourceChange: function (source) {

    var start = Date.now();

    if (source === this._source) return;

    if (this._sjanitor) this._sjanitor.dispose();
    this._insertQueue = [];


    // is it an array? convert into a bindable collection
    if (type(source) === &quot;array&quot;) {
      source = new bindable.Collection(source);
    }

    this._source = source;

    var j = this._sjanitor = janitor();

    // TODO - bottleneck - need to dispose items without calling section.removeAll()
    // for children
    this._removeAllViews();


    if (!source) return;

    // listen to the source for any changes
    j.
      add(source.on(&quot;insert&quot;, this._onInsertModel)).
      add(source.on(&quot;remove&quot;, this._onRemoveModel)).
      add(source.on(&quot;reset&quot;, this._onResetModels)).
      add(source.on(&quot;replace&quot;, this._onReplaceModels));

    // insert all the items in the source collection
    this._onResetModels(source.source());
  },

  /**
   */

  _onMapChange: function (map) {
    this._map = map;
  },

  /**
   */

  _removeAllViews: function () {
    this.section.removeAll();
    for(var i = this._views.length; i--;) {
      this._views.at(i).dispose();
    }

    // remove all the views
    this._views.source([]);
  },

  /**
   */

  _onResetModels: function (newModels, oldModels) {
    this._removeAllViews();
    this._insertModels(newModels);
  },

  /**
   */

  _insertModels: function (models) {
    var modelsToInsert = [];


    for (var i = 0, n = models.length; i &lt; n; i++) {

      var model = models[i];

      if(this._map) {
        model = this._map(model);
      }

      this._sjanitor.add(this._watchModelChanges(model));

      if (this._filter &amp;&amp; !this._filter(model, this)) {
        continue;
      }
      modelsToInsert.push(model);

      // uneccessary overhead calling .get()
      if (!model.__context._cid) {
        model.set(&quot;_cid&quot;, idGenerator());
      }

      var self = this;

      if (this.delay) {
        this._insertLater(model);
      }
    }

    if (!this.delay) {
      this._insertNow(modelsToInsert, true);
    }
  },

  /**
   */

  _removeModels: function (models) {
    var self = this;
    models.forEach(function (model) {
      self._onRemoveModel(model);
    }) 
  },

  /**
   */

  _onReplaceModels: function (newModels, oldModels) {
    this._removeModels(oldModels);
    this._insertModels(newModels);
  },

  /**
   */

  _onInsertModel: function (model, index) {
    this._insertModels([model]);
  },  

  /**
   */

  _insertLater: function (model) {

    // might happen on filter
    if(~this._insertQueue.indexOf(model)) {
      return;
    }

    this._insertQueue.push(model);
    if (this._runLater) return;

    var self = this

    function tick () {

      // synchronously add these models
      var models = self._insertQueue.splice(0, self.chunk);

      // no more items? stop the timer
      if (!models.length || !self._runLater) {
        self._runLater = false;
        return;
      }

      self._insertNow(models, false);
      self._resort();

      runlater(function () {
        self.application.animate({ update: tick });
      });
    }

    this._runLater = true;

    this.application.animate({ update: tick });
  },

  /**
   */

  remove: function () {
    ListView.__super__.remove.call(this);
    if (this._runLater) this._runLater = false;
    if (this._sjanitor) this._sjanitor.dispose();
    this._source = undefined;
    this._bbound
    this._views.source([]);
    this._insertQueue = [];
  },


  /**
   */

  _insertNow: function (models, resort) {

    var view, model, views = [], frags = [];

    this._inserting = models;

    for (var i = 0, n = models.length; i &lt; n; i++) {
      model = models[i];

      if(~this._searchViewIndexById(model.__context._cid)) continue;

      // create the view
      view = this._modelViewFactory.create({
        model        : model,
        parent       : this,
        application  : this.application
      });


      views.push(view);
      frags.push(view.render());
    }

    this._inserting = [];


    if (!frags.length) {
      return;
    }


    this._views.splice.apply(this._views, [this._views.length, 0].concat(views));
    this.section.append(this.application.nodeFactory.createFragment(frags));


    if(resort) this._resort();
  },

  /**
   */

  _searchViewIndexById: function (_id) {
    var src = this._views.source();
    for (var i = src.length; i--;) {
      if(src[i].__context.model.__context._cid == _id) return i;
    }
    return -1;
  },

  /**
   */

  _watchModelChanges: function (model) {
    var self = this;
    if (!model.on) return {
      dispose: function () { }
    };
    return model.on(&quot;change&quot;, function () {
      if (!self._inserting || !~self._inserting.indexOf(model))
        self._refilter([model]);
    });
  },

  /**
   */

  _onRemoveModel: function (model, index, viewIndex) {

    // might happen if the collection is also a model
    if (!model) return;

    var i;

    // remove the item that has not been added to the DOM yet
    if (~(i = this._insertQueue.indexOf(model))) {
      this._insertQueue.splice(i, 1);
    }

    if (viewIndex === undefined) {
      viewIndex = this._searchViewIndexById(model.__context._cid);
    }

    if (!~viewIndex) {
      return;
    }


    var view = this._views.at(viewIndex);
    view.dispose();
    this._views.splice(viewIndex, 1);
  },

  /**
   */

  _onSortChange: function (sort) {
    this._sort = sort;
    this._resort();
  },

  /**
   */

  _resort: function () {
    if (!this._sort) return;

    var frag = this._views.source().sort(this._sort).map(function (view) {
      return view.section.remove();
    });

    this.section.append(this.application.nodeFactory.createFragment(frag));
  },


  /**
   */

  _onFilterChange: function (filter) {
    this._filter = filter;

    if (this._source &amp;&amp; filter) {
      this._refilter(this._source.source());
    }
  },

  /**
   */

  _refilter: function (models) {


    if (!this._filter) return;


    var i, model, useModel, modelIndex;

    var insertModels = [];

    for (i = models.length; i--;) {
      model       = models[i];
      useModel    = !!this._filter(model, this);
      modelIndex  = this._searchViewIndexById(model.__context._cid);

      if (useModel === !!~modelIndex) {
        continue;
      }

      if (useModel) {
        insertModels.push(model);
      } else {
        this._onRemoveModel(model, undefined, modelIndex);
      }
    }

    if (insertModels.length)
      this._insertModels(insertModels);
  }



});


module.exports = ListView;
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
